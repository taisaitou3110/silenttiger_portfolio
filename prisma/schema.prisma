generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Word {
  id         String    @id @default(cuid())
  term       String    @unique
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  accuracy   Float     @default(0.0)
  easeFactor Float     @default(2.5)
  interval   Int       @default(0)
  meaning    String
  nextReview DateTime  @default(now())
  phonetic   String?
  scene      String?
  examples   Example[]
  Word_A     Word[]    @relation("Confusion")
  Word_B     Word[]    @relation("Confusion")
}

model Example {
  id          String   @id @default(cuid())
  text        String
  collocation String?
  audioUrl    String?
  wordId      String
  createdAt   DateTime @default(now())
  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
}

model UserSettings {
  id             String         @id @default(cuid())
  targetCalories Int            @default(2000)
  weight         Float?
  activityLevel  String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  gold           Int            @default(0)
  books          Book[]
  calorieLogs    CalorieLog[]
  customFoods    CustomFood[]
  trainingPools  TrainingPool[]
  userProfiles   UserProfile[]
}

model Book {
  id              String        @id @default(cuid())
  title           String
  authors         String?
  isbn            String?
  thumbnail       String?
  utilizationDate DateTime?
  status          String        @default("COMPLETED")
  userId          String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  user            UserSettings? @relation(fields: [userId], references: [id])

  @@unique([userId, isbn])
}

model CalorieLog {
  id          String        @id @default(cuid())
  date        DateTime      @default(now())
  foodName    String
  calories    Int
  imagePath   String?
  advice      String?
  inputSource String?
  userId      String?
  user        UserSettings? @relation(fields: [userId], references: [id])
}

model CustomFood {
  id       String        @id @default(cuid())
  name     String        @unique
  calories Int
  userId   String?
  user     UserSettings? @relation(fields: [userId], references: [id])
}

model FoodPreset {
  id       String @id @default(cuid())
  name     String @unique
  calories Int
}

model PokerAchiever {
  id         String   @id @default(cuid())
  name       String   @unique
  achievedAt DateTime @default(now())
  finalGold  Int
}

model Feedback {
  id        Int      @id @default(autoincrement())
  name      String   @default("匿名")
  category  String
  content   String   @db.VarChar(100)
  reply     String?
  createdAt DateTime @default(now())
}

model DevelopmentLog {
  id         Int      @id @default(autoincrement())
  date       DateTime
  title      String   @db.VarChar(30)
  progress   String   @db.VarChar(100)
  issues     String   @db.VarChar(400)
  attachment String?
  createdAt  DateTime @default(now())
}

model UserProfile {
  id               String         @id @default(cuid())
  displayName      String
  penType          String?
  trainingLevel    Int            @default(0)
  lastTrainedAt    DateTime       @updatedAt
  settingsId       String?
  createdAt        DateTime       @default(now())
  
  // --- 文体学習用フィールド (再定義) ---
  styleInstruction String?        @db.Text
  learningLevel    Int            @default(0)
  lastAnalyzedAt   DateTime?

  trainingPool     TrainingPool[]
  settings         UserSettings?  @relation(fields: [settingsId], references: [id])
}

model TrainingTemplate {
  id          String @id @default(cuid())
  step        Int
  category    String
  targetText  String
  description String
}

model TrainingPool {
  id           String        @id @default(cuid())
  userId       String?
  imagePatch   String
  correctLabel String
  confidence   Float
  createdAt    DateTime      @default(now())
  profileId    String
  profile      UserProfile   @relation(fields: [profileId], references: [id])
  user         UserSettings? @relation(fields: [userId], references: [id])
}

model Customer {
  id           String        @id @default(cuid())
  name         String
  tel          String?
  zipCode      String?
  address      String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  orders       Order[]
  requirements Requirement[]

  @@unique([name, tel])
}

model Requirement {
  id         String   @id @default(cuid())
  customerId String
  receivedAt DateTime @default(now())
  content    String
  createdAt  DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id])
}

model Order {
  id         Int      @id @default(autoincrement())
  customerId String
  orderDate  DateTime @default(now())
  itemName   String
  quantity   Float
  price      Float
  createdAt  DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id])
}

model GeneralNote {
  id        String   @id @default(cuid())
  rawText   String
  createdAt DateTime @default(now())
}
